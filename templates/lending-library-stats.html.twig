{#
/**
 * @file
 * Theme template for the Lending Library statistics dashboard.
 */
#}

{% set last_month = stats.periods.last_month ?? {} %}
{% set rolling = stats.periods.rolling_90_days ?? {} %}
{% set last_month_start = last_month.start ?? null %}
{% set last_month_end = last_month.end ?? null %}

<div class="container my-4 lending-library-stats">
  <header class="p-4 p-lg-5 bg-light border rounded mb-4">
    <div class="row gy-3 align-items-center">
      <div class="col-lg-8">
        <p class="text-uppercase text-muted small mb-1">{{ 'Lending library'|t }}</p>
        <h1 class="h3 mb-2">{{ 'Usage insights'|t }}</h1>
        <p class="text-secondary mb-0">
          {{ 'Track tool circulation, borrowing patterns, and equipment demand with the same dataset used by the makerspace dashboard.'|t }}
        </p>
      </div>
      <div class="col-lg-4">
        <dl class="row mb-0 small">
          <dt class="col-5 text-uppercase text-muted">{{ 'Last updated'|t }}</dt>
          <dd class="col-7 fw-semibold mb-2">{{ stats.generated|date('M j, Y g:ia T') }}</dd>
          <dt class="col-5 text-uppercase text-muted">{{ 'Coverage'|t }}</dt>
          <dd class="col-7 fw-semibold mb-0">
            {{ last_month.label|default('Last month'|t) }}
            <span class="text-muted">·</span>
            {{ 'rolling 90 days'|t }}
          </dd>
        </dl>
      </div>
    </div>
  </header>

  <section class="mb-5" aria-labelledby="snapshot-heading">
    <div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
      <div>
        <p class="text-uppercase text-muted small mb-1">{{ 'Live snapshot'|t }}</p>
        <h2 id="snapshot-heading" class="h4 mb-0">{{ 'Right now in the tool library'|t }}</h2>
      </div>
      <p class="text-muted small mb-0">
        {{ 'Refreshes every few minutes so staff can triage overdue returns and high-value loans before members arrive.'|t }}
      </p>
    </div>
    {% set overdue_borrowers = stats.current.borrowers_with_overdue|default(0) %}
    {% set summary_cards = [
      {
        key: 'active_loans',
        label: 'Active loans'|t,
        value: stats.current.active_loans|default(0),
        help: 'Tools currently checked out.'|t
      },
      {
        key: 'value_on_loan',
        label: 'Value on loan'|t,
        value: '$' ~ stats.current.inventory_value_on_loan|number_format(2, '.', ','),
        help: 'Replacement value in members’ hands.'|t
      },
      {
        key: 'overdue_loans',
        label: 'Overdue withdrawals'|t,
        value: stats.current.overdue_loans|default(0),
        help: 'Loans past their promised return date.'|t
      },
      {
        key: 'active_borrowers',
        label: 'Active borrowers'|t,
        value: stats.current.active_borrowers|default(0),
        help: 'Members with at least one open loan.'|t
      }
    ] %}
    <div class="row g-3">
      {% for card in summary_cards %}
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card shadow-sm h-100 border-0">
            <div class="card-body">
              <p class="text-uppercase text-muted small mb-1">{{ card.label }}</p>
              <div class="display-6 fw-semibold">{{ card.value }}</div>
              <p class="text-muted small mb-0">
                {{ card.help }}
                {% if card.key == 'active_borrowers' and overdue_borrowers %}
                  <br>
                  <span class="text-danger">
                    {{ '@count borrower(s) currently have overdue loans.'|t({'@count': overdue_borrowers}) }}
                  </span>
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      {% endfor %}
      {% set inventory = stats.inventory_totals|default({'count': 0, 'value': 0}) %}
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card shadow-sm h-100 border-0">
          <div class="card-body">
            <p class="text-uppercase text-muted small mb-1">{{ 'Library footprint'|t }}</p>
            <div class="display-6 fw-semibold">{{ inventory.count }}</div>
            <p class="text-muted small mb-0">
              {{ 'Cataloged tools worth @value'|t({'@value': '$' ~ inventory.value|number_format(2, '.', ',')}) }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-5" aria-labelledby="periods-heading">
    <div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
      <div>
        <p class="text-uppercase text-muted small mb-1">{{ 'Period over period'|t }}</p>
        <h2 id="periods-heading" class="h4 mb-0">{{ 'Last month vs. rolling 90 days'|t }}</h2>
      </div>
      <p class="text-muted small mb-0">
        {{ 'Last month covers the previous full calendar month'|t }}
        {% if last_month_start and last_month_end %}
          ({{ last_month_start|date('M j') }} – {{ (last_month_end - 86400)|date('M j') }}).
        {% else %}
          {{ 'Data will populate once more transactions are recorded.'|t }}
        {% endif %}
      </p>
    </div>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <p class="text-uppercase text-muted small mb-1">{{ 'Last month'|t }}</p>
            <h3 class="h5">{{ last_month.label|default('Not enough data'|t) }}</h3>
            <dl class="row small mb-0 mt-3">
              <dt class="col-5 text-uppercase text-muted">{{ 'Loans'|t }}</dt>
              <dd class="col-7 mb-3">
                <span class="fw-semibold">{{ last_month.metrics.loan_count|default(0) }}</span>
                <span class="text-muted">· {{ '@count unique tools'|t({'@count': last_month.metrics.unique_items|default(0)}) }}</span>
              </dd>
              <dt class="col-5 text-uppercase text-muted">{{ 'Borrowers'|t }}</dt>
              <dd class="col-7 mb-3">
                <span class="fw-semibold">{{ last_month.metrics.unique_borrowers|default(0) }}</span>
                <span class="text-muted">
                  {% if last_month.metrics.repeat_borrower_rate is not empty %}
                    {{ '@rate% repeaters'|t({'@rate': (last_month.metrics.repeat_borrower_rate * 100)|number_format(1)}) }}
                  {% else %}
                    {{ 'Tracking return visitors'|t }}
                  {% endif %}
                </span>
              </dd>
              <dt class="col-5 text-uppercase text-muted">{{ 'Value borrowed'|t }}</dt>
              <dd class="col-7 mb-3">
                <span class="fw-semibold">${{ last_month.metrics.total_value|default(0)|number_format(2, '.', ',') }}</span>
                <span class="text-muted">
                  {% if last_month.metrics.average_value_per_loan is not empty %}
                    {{ '$@avg / loan'|t({'@avg': last_month.metrics.average_value_per_loan|number_format(2)}) }}
                  {% else %}
                    {{ 'Replacement value per checkout'|t }}
                  {% endif %}
                </span>
              </dd>
              <dt class="col-5 text-uppercase text-muted">{{ 'Loan length'|t }}</dt>
              <dd class="col-7">
                {% if last_month.metrics.average_loan_length_days is not empty %}
                  <span class="fw-semibold">{{ last_month.metrics.average_loan_length_days|number_format(1) }} {{ 'days'|t }}</span>
                {% else %}
                  <span class="fw-semibold">—</span>
                {% endif %}
                <span class="text-muted d-block">
                  {% if last_month.metrics.median_loan_length_days is not empty %}
                    {{ 'Median @days days'|t({'@days': last_month.metrics.median_loan_length_days|number_format(1)}) }}
                  {% else %}
                    {{ 'Waiting for completed returns'|t }}
                  {% endif %}
                </span>
              </dd>
            </dl>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <p class="text-uppercase text-muted small mb-1">{{ 'Rolling 90 days'|t }}</p>
            <h3 class="h5">{{ rolling.label|default('Not enough data'|t) }}</h3>
            <dl class="row small mb-0 mt-3">
              <dt class="col-5 text-uppercase text-muted">{{ 'Loans'|t }}</dt>
              <dd class="col-7 mb-3">
                <span class="fw-semibold">{{ rolling.metrics.loan_count|default(0) }}</span>
                <span class="text-muted">
                  {% if rolling.metrics.average_loans_per_borrower is not empty %}
                    · {{ '@count per borrower'|t({'@count': rolling.metrics.average_loans_per_borrower|number_format(2)}) }}
                  {% else %}
                    · {{ 'Borrowing frequency'|t }}
                  {% endif %}
                </span>
              </dd>
              <dt class="col-5 text-uppercase text-muted">{{ 'Borrowers'|t }}</dt>
              <dd class="col-7 mb-3">
                <span class="fw-semibold">{{ rolling.metrics.unique_borrowers|default(0) }}</span>
                <span class="text-muted">· {{ '@count completed loans'|t({'@count': rolling.metrics.completed_loans|default(0)}) }}</span>
              </dd>
              <dt class="col-5 text-uppercase text-muted">{{ 'On-time returns'|t }}</dt>
              <dd class="col-7 mb-3">
                {% if rolling.metrics.on_time_return_rate is not empty %}
                  <span class="fw-semibold">{{ (rolling.metrics.on_time_return_rate * 100)|number_format(1) }}%</span>
                {% else %}
                  <span class="fw-semibold">—</span>
                {% endif %}
                <span class="text-muted d-block">{{ 'Based on check-ins with due dates.'|t }}</span>
              </dd>
              <dt class="col-5 text-uppercase text-muted">{{ 'Loan duration'|t }}</dt>
              <dd class="col-7">
                {% if rolling.metrics.average_loan_length_days is not empty %}
                  <span class="fw-semibold">{{ rolling.metrics.average_loan_length_days|number_format(1) }} {{ 'days'|t }}</span>
                {% else %}
                  <span class="fw-semibold">—</span>
                {% endif %}
                <span class="text-muted d-block">
                  {% if rolling.metrics.median_loan_length_days is not empty %}
                    {{ 'Median @days days'|t({'@days': rolling.metrics.median_loan_length_days|number_format(1)}) }}
                  {% else %}
                    {{ 'Waiting for return data'|t }}
                  {% endif %}
                </span>
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-5" aria-labelledby="charts-heading">
    <div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
      <div>
        <p class="text-uppercase text-muted small mb-1">{{ 'Demand signals'|t }}</p>
        <h2 class="h4 mb-0" id="charts-heading">{{ 'What people are borrowing'|t }}</h2>
      </div>
      <p class="text-muted small mb-0">{{ 'Charts render via the Drupal Charts module; tables remain for quick exports and screen readers.'|t }}</p>
    </div>
    <div class="row g-3">
      <div class="col-lg-12">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h3 class="h5">{{ 'Full lending history'|t }}</h3>
            {% if charts.full_history %}
              <div class="mb-3">
                {{ charts.full_history }}
              </div>
            {% else %}
              <p class="text-muted">{{ 'No historical data available.'|t }}</p>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h3 class="h5">{{ 'Monthly loan volume (previous 12 months)'|t }}</h3>
            {% if charts.monthly %}
              <div class="mb-3">
                {{ charts.monthly }}
              </div>
            {% else %}
              <p class="text-muted">{{ 'No lending activity recorded within the last year.'|t }}</p>
            {% endif %}
            {% set monthly_points = stats.chart_data.monthly_loans|default([]) %}
            {% if monthly_points %}
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th scope="col">{{ 'Month'|t }}</th>
                    <th scope="col" class="text-end">{{ 'Loans'|t }}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for point in monthly_points %}
                    <tr>
                      <th scope="row">{{ point.label }}</th>
                      <td class="text-end">{{ point.value }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h3 class="h5">{{ 'Most borrowed categories (last 90 days)'|t }}</h3>
            {% if charts.categories %}
              <div class="mb-3">
                {{ charts.categories }}
              </div>
            {% else %}
              <p class="text-muted">{{ 'No categorized loans logged during the last 90 days.'|t }}</p>
            {% endif %}
            {% set categories = stats.chart_data.top_categories|default([]) %}
            {% if categories %}
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th scope="col">{{ 'Category'|t }}</th>
                    <th scope="col" class="text-end">{{ 'Loans'|t }}</th>
                    <th scope="col" class="text-end">{{ 'Share'|t }}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for category in categories %}
                    <tr>
                      <th scope="row">{{ category.label }}</th>
                      <td class="text-end">{{ category.value }}</td>
                      <td class="text-end">{{ (category.share * 100)|number_format(1) }}%</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              <p class="text-muted small mt-2">{{ 'Tools can belong to multiple categories, so percentages may exceed 100%.'|t }}</p>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-lg-12">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h3 class="h5">{{ 'Most borrowed tools (all time)'|t }}</h3>
            {% set top_tools = stats.chart_data.most_borrowed_tools|default([]) %}
            {% if top_tools %}
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th scope="col">{{ 'Tool Name'|t }}</th>
                      <th scope="col" class="text-end">{{ 'Total Loans'|t }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for tool in top_tools %}
                      <tr>
                        <th scope="row">{{ tool.label }}</th>
                        <td class="text-end">{{ tool.value }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted">{{ 'No loan data available.'|t }}</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>

  {% if stats.batteries is not empty %}
    {% set batteries = stats.batteries %}
    <section class="mb-5" aria-labelledby="battery-heading">
      <div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
        <div>
          <p class="text-uppercase text-muted small mb-1">{{ 'Battery pool'|t }}</p>
          <h2 id="battery-heading" class="h4 mb-0">{{ 'Charging pack utilization'|t }}</h2>
        </div>
        <p class="text-muted small mb-0">
          {{ '@borrowed of @total packs checked out (@ratio%)'|t({
            '@borrowed': batteries.borrowed,
            '@total': batteries.total,
            '@ratio': batteries.borrowed_ratio|number_format(1)
          }) }}
        </p>
      </div>
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <p class="text-uppercase text-muted small mb-1">{{ 'Checked out'|t }}</p>
              <div class="display-6 fw-semibold">{{ batteries.borrowed }}</div>
              <p class="text-muted small mb-0">
                {{ '@count borrowers currently have batteries in use.'|t({'@count': batteries.borrower_count}) }}
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <p class="text-uppercase text-muted small mb-1">{{ 'Ready to lend'|t }}</p>
              <div class="display-6 fw-semibold">{{ batteries.available }}</div>
              <p class="text-muted small mb-0">{{ 'Charged and available packs.'|t }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <p class="text-uppercase text-muted small mb-1">{{ 'Missing or service'|t }}</p>
              <div class="display-6 fw-semibold">{{ batteries.missing + batteries.other }}</div>
              <p class="text-muted small mb-0">{{ 'Flagged as missing or awaiting maintenance.'|t }}</p>
            </div>
          </div>
        </div>
      </div>
      <p class="text-muted small mt-2">
        {{ 'Totals pull from the battery entity’s status field; counts update whenever a transaction borrows or returns a battery.'|t }}
      </p>
    </section>
  {% endif %}

  {% set retention = stats.retention_insights|default([]) %}
  {% set borrower_insight = retention.borrower|default({'count': 0, 'average': null, 'median': null}) %}
  {% set non_borrower_insight = retention.non_borrower|default({'count': 0, 'average': null, 'median': null}) %}
  {% if borrower_insight.count or non_borrower_insight.count %}
    <section class="mb-5" aria-labelledby="retention-heading">
      <div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
        <div>
          <p class="text-uppercase text-muted small mb-1">{{ 'Retention signal'|t }}</p>
          <h2 class="h4 mb-0" id="retention-heading">{{ 'Did borrowers stay members longer?'|t }}</h2>
        </div>
        <p class="text-muted small mb-0">
          {{ 'Calculated from member profile creation to recorded end date (former members only). Only includes members who joined since 2021.'|t }}
        </p>
      </div>
      <div class="card shadow-sm">
        <div class="card-body p-0">
          {% set retention_rows = [
            {'label': 'Former borrowers'|t, 'data': borrower_insight},
            {'label': 'Former members (no borrower role)'|t, 'data': non_borrower_insight}
          ] %}
          <table class="table mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th scope="col">{{ 'Cohort'|t }}</th>
                <th scope="col" class="text-end">{{ 'Former members'|t }}</th>
                <th scope="col" class="text-end">{{ 'Average length (days)'|t }}</th>
                <th scope="col" class="text-end">{{ 'Median length (days)'|t }}</th>
              </tr>
            </thead>
            <tbody>
              {% for row in retention_rows %}
                {% set data = row.data %}
                <tr>
                  <th scope="row">{{ row.label }}</th>
                  <td class="text-end">{{ data.count }}</td>
                  <td class="text-end">
                    {% if data.average is not null %}
                      {{ data.average|number_format(1) }}
                      <span class="text-muted small d-block">
                        {{ '≈ @months months'|t({'@months': (data.average / 30)|number_format(1) }) }}
                      </span>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if data.median is not null %}
                      {{ data.median|number_format(1) }}
                      <span class="text-muted small d-block">
                        {{ '≈ @months months'|t({'@months': (data.median / 30)|number_format(1) }) }}
                      </span>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  {% endif %}

  {% set cohort_rows = stats.retention_cohorts|default([]) %}
  {% if cohort_rows %}
    <section class="mb-5" aria-labelledby="cohort-heading">
      <div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
        <div>
          <p class="text-uppercase text-muted small mb-1">{{ 'Active membership by join year'|t }}</p>
          <h2 class="h4 mb-0" id="cohort-heading">{{ 'Borrowers vs non-borrowers'|t }}</h2>
        </div>
        <p class="text-muted small mb-0">{{ 'Shows the share of members from each join year who still hold the member role today.'|t }}</p>
      </div>
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <table class="table mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th scope="col">{{ 'Join year'|t }}</th>
                <th scope="col" class="text-end">{{ 'Borrowers active'|t }}</th>
                <th scope="col" class="text-end">{{ 'Non-borrowers active'|t }}</th>
              </tr>
            </thead>
            <tbody>
              {% for row in cohort_rows %}
                <tr>
                  <th scope="row">{{ row.year }}</th>
                  <td class="text-end">
                    {% if row.borrower.total %}
                      {{ row.borrower.rate is not null ? row.borrower.rate|number_format(1) ~ '%' : '—' }}
                      <span class="text-muted small d-block">
                        {{ '@active of @total'|t({'@active': row.borrower.active, '@total': row.borrower.total}) }}
                      </span>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if row.non_borrower.total %}
                      {{ row.non_borrower.rate is not null ? row.non_borrower.rate|number_format(1) ~ '%' : '—' }}
                      <span class="text-muted small d-block">
                        {{ '@active of @total'|t({'@active': row.non_borrower.active, '@total': row.non_borrower.total}) }}
                      </span>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  {% endif %}

  <section aria-labelledby="library-links" class="mb-5">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <div>
        <p class="text-uppercase text-muted small mb-1">{{ 'Next steps'|t }}</p>
        <h2 id="library-links" class="h4 mb-0">{{ 'Explore the lending library'|t }}</h2>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h3 class="h5">{{ 'Browse all tools'|t }}</h3>
            <p class="text-muted">{{ 'See the full catalog, availability, and waitlist info.'|t }}</p>
            <a class="btn btn-outline-primary" href="/library">{{ 'Visit the catalog'|t }}</a>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h3 class="h5">{{ 'Borrowed items queue'|t }}</h3>
            <p class="text-muted">{{ 'Staff view of checked-out tools, due dates, and renewals.'|t }}</p>
            <a class="btn btn-outline-primary" href="/library/borrowed">{{ 'Open borrowed items'|t }}</a>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
