{# templates/lending-library-dashboard.html.twig #}
{{ attach_library('lending_library/lending_library.actions') }}

<div class="lending-library-dashboard">
  <div class="dashboard-header">
    <div>
      <h2>Lending Library Manager Dashboard</h2>
      <p class="dashboard-intro">Overview of current inventory, outstanding loans, and system triggers.</p>
    </div>
    <div class="header-actions">
      <a href="/lending-library/stats" class="button">View Full Analytics</a>
    </div>
  </div>

  <div class="dashboard-key-stats">
    <div class="key-stat">
      <div class="stat-label">Loans (Last 30 Days)</div>
      <div class="stat-number">{{ key_stats.last_month.loans }}</div>
      <div class="stat-sub">{{ key_stats.last_month.users }} unique borrowers</div>
    </div>
    <div class="key-stat">
      <div class="stat-label">Loans (Last 90 Days)</div>
      <div class="stat-number">{{ key_stats.rolling_90.loans }}</div>
      <div class="stat-sub">{{ key_stats.rolling_90.users }} unique borrowers</div>
    </div>
    <div class="key-stat">
      <div class="stat-label">Active Loans</div>
      <div class="stat-number">{{ stats.lent_items }}</div>
      <div class="stat-sub">Current total</div>
    </div>
    <div class="key-stat">
      <div class="stat-label">Total Late Fees</div>
      <div class="stat-number">${{ stats.total_owed|number_format(2) }}</div>
      <div class="stat-sub">Outstanding balance</div>
    </div>
  </div>

  <div class="dashboard-grid">
    {# Left Column: Stats & Alerts #}
    <div class="dashboard-column">
      <div class="stat-card alert-card">
        <h3>Triggers & Alerts</h3>
        <p class="help-text">
          <strong>Due Soon:</strong> Sent 1 day before due date.<br>
          <strong>Overdue:</strong> Fees apply immediately after due date.
        </p>
        <div class="stat-row">
          <span class="stat-label">Items Due Tomorrow:</span>
          <span class="stat-value">{{ triggers.due_soon_count }}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Items Overdue:</span>
          <span class="stat-value error">{{ triggers.overdue_count }}</span>
        </div>
      </div>

      <div class="stat-card">
        <h3>Inventory Snapshot</h3>
        <div class="stat-row">
          <span class="stat-label">Available:</span>
          <span class="stat-value status-available">{{ stats.available_items }}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">In Repair:</span>
          <span class="stat-value status-repair">{{ stats.repair_items }}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Missing:</span>
          <span class="stat-value status-missing">{{ stats.missing_items }}</span>
        </div>
      </div>

      {% if active_loans is not empty %}
        <div class="stat-card">
          <h3>Active Loans</h3>
          <table class="responsive-enabled table table-striped table-sm">
            <thead>
              <tr>
                <th>Tool</th>
                <th>Borrower</th>
                <th>Due</th>
              </tr>
            </thead>
            <tbody>
              {% for item in active_loans %}
                <tr>
                  <td><a href="/node/{{ item.tool_id }}">{{ item.tool }}</a></td>
                  <td>{{ item.borrower }}</td>
                  <td>{{ item.due_date }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

       {% if due_soon_items is not empty %}
        <div class="stat-card">
          <h3>Upcoming Returns (Due Soon)</h3>
          <table class="responsive-enabled table table-striped table-sm">
            <thead>
              <tr>
                <th>Tool</th>
                <th>Borrower</th>
                <th>Due</th>
              </tr>
            </thead>
            <tbody>
              {% for item in due_soon_items %}
                <tr>
                  <td><a href="/node/{{ item.tool_id }}">{{ item.tool }}</a></td>
                  <td>{{ item.borrower }}</td>
                  <td>{{ item.due_date }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

      {% if overdue_items is not empty %}
        <div class="stat-card">
          <h3>Currently Overdue</h3>
          <table class="responsive-enabled table table-striped table-sm">
            <thead>
              <tr>
                <th>Tool</th>
                <th>Borrower</th>
                <th>Late</th>
              </tr>
            </thead>
            <tbody>
              {% for item in overdue_items %}
                <tr>
                  <td><a href="/node/{{ item.tool_id }}">{{ item.tool }}</a></td>
                  <td>{{ item.borrower }}</td>
                  <td class="error">{{ item.days_overdue }} days</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

      {% if damaged_items is not empty %}
        <div class="stat-card">
          <h3>Items In Repair</h3>
          <table class="responsive-enabled table table-striped table-sm">
            <thead>
              <tr>
                <th>Tool</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody>
              {% for item in damaged_items %}
                <tr>
                  <td><a href="/node/{{ item.nid }}">{{ item.title }}</a></td>
                  <td>{{ item.changed }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

      {% if debtors is not empty %}
        <div class="stat-card">
          <h3>Outstanding Balances</h3>
          <table class="responsive-enabled table table-striped table-sm">
            <thead>
              <tr>
                <th>Borrower</th>
                <th>Tool</th>
                <th>Due Date</th>
                <th>Balance</th>
              </tr>
            </thead>
            <tbody>
              {% for debtor in debtors %}
                <tr>
                  <td>{{ debtor.borrower }}</td>
                  <td>{{ debtor.tool }}</td>
                  <td>{{ debtor.due_date ?? 'N/A' }}</td>
                  <td class="error"><a href="{{ debtor.transaction_url }}" class="balance-link">${{ debtor.amount|number_format(2) }}</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>

    {# Right Column: Actions (Grouped) #}
    <div class="dashboard-column">
      {% for group, links in grouped_links %}
        <div class="stat-card actions-card">
          <h3>{{ group }}</h3>
          <ul class="action-list">
            {% for link in links %}
              <li class="action-item">
                <a href="{{ link.url }}" class="button button--small">{{ link.title }}</a>
                <div class="action-desc">{{ link.description }}</div>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="dashboard-activity-section">
    <h3>Recent System Activity</h3>
    <p class="help-text">Recent emails sent and system errors logged.</p>
    <table class="responsive-enabled table table-striped">
      <thead>
        <tr>
          <th>Time</th>
          <th>Message</th>
          <th>Severity</th>
        </tr>
      </thead>
      <tbody>
        {% for log in recent_activity %}
          <tr class="log-row severity-{{ log.severity }}">
            <td class="log-time">{{ log.time }}</td>
            <td class="log-message">{{ log.message }}</td>
            <td class="log-severity">
               {% if log.severity <= 3 %}
                 <span class="marker error">Error</span>
               {% elseif log.severity == 4 %}
                 <span class="marker warning">Warning</span>
               {% else %}
                 <span class="marker info">Info</span>
               {% endif %}
            </td>
          </tr>
        {% else %}
          <tr><td colspan="3">No recent activity found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
  .lending-library-dashboard {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    max-width: 1200px;
    margin: 0 auto;
  }
  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
  }
  .dashboard-header h2 { margin-top: 0; }
  .dashboard-key-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }
  .key-stat {
    background: #fff;
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .key-stat .stat-label { font-size: 0.9em; color: #666; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 0.5px; }
  .key-stat .stat-number { font-size: 2em; font-weight: bold; color: #2563eb; line-height: 1.2; }
  .key-stat .stat-sub { font-size: 0.85em; color: #888; margin-top: 5px; }

  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-bottom: 30px;
  }
  @media (min-width: 768px) {
    .dashboard-grid {
      grid-template-columns: 2fr 1fr;
    }
  }
  .stat-card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .stat-card h3 { margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.2em;}
  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f5f5f5;
  }
  .stat-row:last-child { border-bottom: none; }
  .stat-value { font-weight: bold; font-size: 1.2em; }
  .status-borrowed { color: #2563eb; }
  .status-missing { color: #dc2626; }
  .status-repair { color: #d97706; }
  .alert-card { background-color: #fffaf0; border-color: #fbd38d; }
  .alert-card h3 { border-color: #fbd38d; }
  .stat-value.error { color: #dc2626; }
  
  .action-list { list-style: none; padding: 0; margin: 0; }
  .action-item { display: flex; flex-direction: column; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
  .action-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
  .action-item .button { width: 100%; text-align: center; box-sizing: border-box; margin-bottom: 5px; }
  .action-desc { font-size: 0.85em; color: #666; }
  
  .dashboard-activity-section {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 20px;
  }
  .marker { padding: 3px 8px; border-radius: 12px; font-size: 0.75em; text-transform: uppercase; font-weight: bold; }
  .marker.error { background: #fee2e2; color: #991b1b; }
  .marker.warning { background: #fef3c7; color: #92400e; }
  .marker.info { background: #dbeafe; color: #1e40af; }
  .help-text { font-size: 0.9em; color: #666; font-style: italic; }
  .table-sm td, .table-sm th { padding: 0.3rem; font-size: 0.9em; }
  .table-sm .error { color: #dc2626; font-weight: bold; }
  .balance-link { color: inherit; text-decoration: underline; }
</style>
